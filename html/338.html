
        <!DOCTYPE html><html><head><link rel="stylesheet" href="./init.css"><title>透彻理解秒杀系统（一）——系统整体架构</title></head>
        <body><div class="blog-info overflow-initial">
<h1 class="blog-info-title">
<strong>透彻理解秒杀系统（一）——系统整体架构</strong>
</h1>
<div class="blog-info-body markdown-body editor-preview-active-side">
<p>本章，我先对<strong>分布式秒杀系统</strong>的整个架构、应用模块划分、主体功能进行讲解，为后续章节作铺垫。这里我特别说明下，分布式秒杀系统涉及到系统架构的方方面面：CDN、网络安全、前端、硬件……在实际的项目中，需要多个不同部门和团队相互协作，我这个系列的重点是在Java后端架构，其它方面只会简单的介绍。</p>
<h2 id="-">一、服务划分</h2>
<p>在正式讲解秒杀系统的架构之前，我们先来思考下一个分布式秒杀系统（seckill）应该具备哪些核心服务。首先，整个分布式秒杀系统肯定是由多个不同的服务相互配合的，并且秒杀系统应该有自己的独立域名和独立入口首页，并作为整个电商平台的一部分：</p>
<center><br/> <img src="./img/20210814144942752.png" style="zoom:25%"><br/></img></center>
<h3 id="1-1-">1.1 秒杀活动管理服务</h3>
<p>秒杀活动管理服务，本质就是一个后台管理系统，主要供运营人员和管理人员使用，核心功能就是对秒杀活动进行统一管理，包括<strong>秒杀场次</strong>、<strong>秒杀商品</strong>、<strong>秒杀价格</strong>、<strong>商品数量</strong>等等。</p>
<p>运营人员可以跟商品品牌方沟通谈判，拿到某个商品的最低价格，或者在公司内部申请一定的补贴，这样就可以吸引到用户，引入流量。</p>
<p>运营人员需要规划一些秒杀场次，确认每一场秒杀活动包含哪些商品，每个商品的折扣价和数量是多少，然后发布秒杀活动。秒杀活动发布后，一般还需进行多层级的审批，审批通过后，电商网站的秒杀活动页才会展示出对应的场次和商品。</p>
<p>同时，秒杀活动的变动还会通知到MQ，便于其它相关系统的订阅：</p>
<center><br/> <img src="./img/20210814144957356.png" style="zoom:50%"/><br/></center>
<h3 id="1-2-">1.2 秒杀前端应用</h3>
<p>秒杀前端应用可以是H5版、APP版、PC版等，包含了秒杀活动的全部前端交互、界面，最终是集成在电商平台中。秒杀前端应用应该每隔一段时间（比如1分钟）从秒杀活动管理服务获取最新的秒杀场次信息。</p>
<center><br/> <img src="./img/20210814145011187.png" style="zoom:50%"/><br/></center>
<h3 id="1-3-">1.3 秒杀页面渲染服务</h3>
<p>秒杀活动页渲染服务，负责将秒杀商品的活动详情页进行<strong>页面静态化</strong>，因为详情页往往是整个秒杀系统中访问频次最高的页面。</p>
<p>秒杀活动页渲染服务依赖的数据来源有很多，比如<strong>秒杀活动管理服务</strong>的活动场次信息，<strong>商品服务</strong>的商品详情信息、<strong>库存服务</strong>的商品库存信息，甚至还有其它<strong>广告服务</strong>等等。所以，秒杀活动页渲染服务需要监听这些依赖系统的数据变动，然后调用各方系统的接口获取最新数据，最后利用模板技术（Freemarker、Velocity等）渲染出静态的HTML商品详情页，推送到Nginx服务群组进行缓存。</p>
<center><br/> <img src="./img/20210814145040692.png" style="zoom:50%"/><br/></center>
<h3 id="1-4-nginx-">1.4 Nginx代理服务</h3>
<p>Nginx静态资源代理服务群组，主要对秒杀活动涉及的静态资源做代理，对于大型电商，会和CDN配合使用。</p>
<center><br/> <img src="./img/20210814145050026.png" style="zoom:50%"/><br/></center>
<h3 id="1-5-">1.5 秒杀抢购服务</h3>
<p>秒杀抢购服务负责处理秒杀活动的核心业务流程，包括库存扣减、下单通知等等。</p>
<p>注意，这里涉及到两个问题：</p>
<ul>
<li><strong>抢购地址暴露问题：</strong>为了避免提前被一些人利用查看页面源码的方式获取到真实抢购地址，可以在抢购开始前由前端发送请求到后端的服务（比如秒杀活动地址服务），获取真实的抢购地址</li>
</ul>
<center><br/> <img src="./img/20210814145110634.png" style="zoom:125%"/><br/></center><br/>- <strong>秒杀授时问题：</strong>用户一般会在秒杀活动页面等待秒杀活动开始，此时需要进行时钟倒计时，但页面和服务端的时间是不同步的，这样就可能会有人把自己电脑和手机的时钟进行调整。所以，一般需要前端定时访问后端的一个<strong>授时服务接口</strong>，进行时钟同步和倒计时<br/><br/><br/><br/><center><br/> <img src="./img/20210814145100245.png" style="zoom:125%"/><br/></center>
<h3 id="1-6-">1.6 秒杀商品库存管理服务</h3>
<p>秒杀商品库存管理服务，主要监听各类数据的变动，比如运营人员对秒杀活动的变更，订单系统对订单状态的更新通知，然后根据通知类型，将商品库存<strong>分片缓存/更新</strong>到Redis集群中：</p>
<center><br/> <img src="./img/20210814145129560.png" style="zoom:125%"/><br/></center>
<h2 id="-">二、系统安全</h2>
<p>秒杀活动涉及到很多系统安全方面的考量，我这里简单介绍下，但不会深入讲解，大一点的公司在安全方面一般都会有专门的安全部门给出解决方案。</p>
<h3 id="2-1-">2.1 动态验证码</h3>
<p>前端应用一般会采用<strong>动态验证码</strong>对一些恶意请求进行校验和拦截，同时，验证码机制可以起到<strong>错峰</strong>的效果，避免秒杀一开始所有人都瞬间发起请求，造成服务器压力过大。</p>
<p>验证码的形式有很多种，从最简单的图片验证码，到拼图校验，再到人机检测……大型电商网站一般都有自己的验证码服务，或者使用商用验证码，这些服务除了基本的校验功能外，还有防刷单和限流的功能。</p>
<h3 id="2-2-">2.2 按钮置灰</h3>
<p>控制页面上的抢购按钮，秒杀开始前都是灰的，秒杀开始后就让点击一次，立马按钮变灰，在一定时间内（比如30秒）不允许重复抢购，避免有人疯狂的点击按钮，不停的发送请求过来。</p>
<h3 id="2-3-ddos-">2.3 DDoS攻击</h3>
<p>DDoS攻击可能直接攻击秒杀抢购服务，可能攻击秒杀商品详情页。举个例子，比如说你购买了CDN产品的10TB资源流量包，然后正常情况下，支撑上百万次请求都没问题，结果有黑客对你的详情页域名进行DDoS攻击，利用很多台服务器发起疯狂的请求，短时间内请求CDN上百万次，就可能把你的10TB的CDN资源流量包全部刷光。</p>
<p>防范DDoS攻击，基本都会用云厂商的DDoS高防商业产品：将独立的二级域名解析到DDoS高防产品去，由DDoS高防产品先过滤请求，然后再发送到秒杀抢购服务。</p>
<h3 id="2-4-">2.4 限流</h3>
<p>限流包含两部分，<strong>整体限流</strong>和<strong>业务限流</strong>。</p>
<p>整体限流可以在Nginx集群做，基于Lua脚本对进入秒杀抢购服务的流量进行整体限流，具体限流数值根据每台Nginx服务器的压测性能进行配置，Nginx支持的常见的限流算法有令牌桶算法和漏桶算法。</p>
<p>业务限流根据具体的业务需求做，对于秒杀业务来说就是根据秒杀场次、秒杀商品数量来控制。比如通过提前将每个商品总数量缓存到Redis，然后通过Lua脚本基于Redis的<code>incrby</code>做累加计数，控制秒杀成功的请求数量，比如1000个商品，最多只能限制1000个左右的请求进入后端的秒杀抢购服务，如果发现放行到后台秒杀抢购服务的抢购请求数量超过1000了，可以直接拒绝后续的抢购请求了。</p>
<center><br/> <img src="./img/20210814145119985.png" style="zoom:100%"/><br/></center>
<h2 id="-">三、数据存储</h2>
<p>秒杀活动涉及的场次、商品等数据必然首先是要保存在数据库中的，但是秒杀活动正式开始前，大量的访问都是读请求浏览商品详情，也就是属于<strong>读多写少</strong>的场景。对于这类场景，我们很容易想到使用分布式缓存（比如Redis）来提升系统的性能。</p>
<p>运营人员在成功发布秒杀活动后，秒杀活动数据（场次、商品、库存等）会被从数据库读取，然后缓存到Redis中，同时为了进一步提升性能，可以做多级缓存，将整个场次的所有商品信息组装成一个大缓存数据包，缓存在前端APP、CDN、Nginx Local Cache等地方，然后设置一个过期时间。</p>
<h3 id="2-1-">2.1 数据结构</h3>
<p>我们来看下秒杀活动中的一些核心实体对应的Redis数据结构。</p>
<h4 id="-">场次列表</h4>
<p>场次可以使用<code>list</code>结构，以日期作为key，保存当天的所有场次ID列表：</p>
<pre><code class="lang-JSON">"seckill::#{当日的日期}::rounds" : [round1, round2, round3]
</code></pre>
<h4 id="-">场次详情</h4>
<p>遍历场次列表，可以拿到每一个场次的ID，然后就可以获取该场次的详情信息，比如该场次的起止时间，包含的商品ID历列表等等：</p>
<pre><code class="lang-json">"seckill::round::#{秒杀场次id}::info" : {
    "id": 1,
    "start_time": "xxx"
    "end_time": "xxxx"
    "product_list": [1,2,3,4,5]
}
</code></pre>
<h4 id="-">商品详情</h4>
<p>从场次详情中，可以获取到该场次下的所有秒杀商品ID列表，遍历列表就可以拿到商品的详情信息，其中包含商品的秒杀价格和秒杀数量：</p>
<pre><code class="lang-JSON">"seckill::#{秒杀场次id}::#{商品id}::info" : {
    "id": 1,
    "name": "XXX商品",
    "dicount_price": 66.00,
    "count": 100
}
</code></pre>
<h2 id="-">四、总结</h2>
<p>本章，我对分布式秒杀系统的整体架构和核心服务进行了讲解，我通过一步步画图拆解的方式详细描述了整个交互链路。从下一章开始，我将深入讲解链路上每一个服务的功能。</p>
</div>


<div class="article-footer overflow-initial">所属分类：<a data-original-title="点击查看分布式秒杀分类的文章" data-placement="bottom" data-toggle="tooltip" href="https://www.tpvlog.com/type/66">分布式秒杀</a></div>
</div></body>
        </html>
        