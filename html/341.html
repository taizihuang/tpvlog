
        <!DOCTYPE html><html><head><link rel="stylesheet" href="./init.css"><title>透彻理解秒杀系统（四）——秒杀抢购服务：全链路高可用</title></head>
        <body><div class="blog-info overflow-initial">
<h1 class="blog-info-title">
<strong>透彻理解秒杀系统（四）——秒杀抢购服务：全链路高可用</strong>
</h1>
<div class="blog-info-body markdown-body editor-preview-active-side">
<p>本章，我将对秒杀抢购的核心链路的高可用问题进行分析，关于高可用，读者可以先看看我的<a href="https://www.tpvlog.com/article/62">《分布式系统从理论到实战》</a>专栏。</p>
<p>在整个分布式秒杀系统中，最重要的链路其实就是<strong>秒杀抢购下单链路</strong>，如下图：</p>
<center><br/> <img src="./img/20210814153243421.png" style="zoom:120%"><br/></img></center>
<p>我们来分析下，在整条核心链路上，需要关注哪些服务的高可用性：</p>
<ul>
<li>SLB负载均衡：SLB一般由数据中心或网络部人员运维，并且LVS本身就是集群部署并用Keepalived做高可用，所以非关注重点；</li>
<li>秒杀抢购Nginx群组：Nginx基本都是集群部署，支持横向伸缩，非关注重点；</li>
<li><strong>秒杀抢购服务：</strong>负责处理核心的扣减库存逻辑，需要重点关注；</li>
<li><strong>Redis集群：</strong>负责缓存秒杀商品的库存，以及执行库存扣减，需要重点关注；</li>
<li><strong>分布式消息中间件：</strong>负责传递秒杀成功的请求，需重点关注；</li>
<li><strong>电商平台订单系统：</strong>负责进行下单操作，虽然不属于秒杀系统的一部分，但也要重点关注；</li>
<li>秒杀下单服务：负责监听MQ的“秒杀成功通知”，然后调用电商平台订单系统的下单接口进行下单，应用本身可以集群部署，非重点关注；</li>
<li>秒杀商品库存服务：负责监听运营人员对秒杀商品库存的配置，应用本身可以集群部署，非重点关注。</li>
</ul>
<p>接下来，我来一一对上面的重点关注服务进行分析，讲解它们的高可用方案。</p>
<h2 id="-mq-">一、MQ高可用</h2>
<p>我们先来看分布式消息中间件的可用性，MQ可以用作削峰、解耦、异步，现在大部分公司一般会选型Kafka或者RokcetMQ。使用消息中间件，最关键的是要考虑<em>消息丢失</em>、<em>消息重复</em>、<em>消息积压</em>这三类问题，同时要考虑消息中间件自身的可用性。</p>
<blockquote>
<p>关于消息中间件的原理、选型、常见问题的解决方案，我在<a href="https://www.tpvlog.com/article/62">《分布式系统从理论到实战》</a>系列已经详细讲解过了，这里不再赘述。</p>
</blockquote>
<h3 id="1-1-">1.1 消息积压</h3>
<p>我们先来看下消息积压的场景，虽然说<strong>秒杀抢购Nginx群组</strong>会拦截掉绝大多数请求，但是在一些极端情况下，可能会在MQ中积压大量"秒杀成功通知"消息。这种情况如果不及时处理，对于用户的体验是很差的，用户在页面可能会一直看到“抢购成功，正在为您生成订单，请耐心等待”的提示，但却迟迟不跳转到订单支付页。</p>
<p>对于这种秒杀抢购成功后的消息积压问题，一般可以采用如下解决方案：</p>
<ol>
<li>秒杀下单服务消费“秒杀成功通知”的消息时，<strong>检查消息写入时间距离当前时间是否已经超过了一定的阈值</strong>（比如2分钟），如果超过就认为MQ发生了消息积压，就直接更新Redis集群中的库存信息，归还可销售库存；</li>
<li>前端设置一个稍大于后端阈值的buffer，比如3分钟，如果超过3分钟还没拉取到订单，就直接提示用户""秒杀抢购失败"，然后重新跳转回抢购商品详情页，让用户重新秒杀下单。</li>
</ol>
<center><br/> <img src="./img/20210814153253994.png" style="zoom:120%"/><br/></center>
<p>另一种的解决方案是<strong>临时扩容机器</strong>，比如你们公司的应用都是基于Docker容器部署的，那一定有一套Web运维管理系统，此时可以针对“秒杀下单服务”，瞬间调度起N倍的pod容器节点，快速把MQ中积压的消息消费掉。</p>
<h3 id="1-2-">1.2 集群崩溃</h3>
<p>分布式消息中间件本身就具有基于数据分片和副本同步的高可用机制，如果某个分片所在的机器宕机了，会进行主从选举，所以不影响整体的可用性。但是，还是得考虑整个MQ集群挂掉或出现网络分区而不可用的情况。</p>
<p>我们来分析一下，当MQ集群崩溃后，秒杀系统仍然能够成功扣减库存，但是没有办法下订单了。所以，针对这种情况的降级方案就是：</p>
<ol>
<li>秒杀抢购服务将“秒杀成功通知”顺序写入本地磁盘；</li>
<li>由一个<strong>秒杀降级处理服务，读取磁盘数据，然后直接调用秒杀下单服务的联机接口进行下单</strong>。</li>
</ol>
<h2 id="-redis-">二、Redis高可用</h2>
<p>Redis本身具有高可用方案，比如<strong>主从+哨兵模式</strong>，<strong>Redis Cluster模式</strong>，所以单个Redis Master节点宕机一般没什么问题。但是，我们需要考虑Redis整个集群挂掉或者出现网络分区无法对外提供服务的情况（虽然这种概率其实很小很小）。</p>
<blockquote>
<p>关于Redis的高可用原理，参见我的<a href="https://www.tpvlog.com/article/62">《分布式系统从理论到实战》</a>专栏。</p>
</blockquote>
<h3 id="2-1-">2.1 集群崩溃</h3>
<p>一旦Redis集群崩溃，秒杀抢购服务就没法完成库存扣减。如果此时直接响应“抢购失败”，那用户体验非常不好，同时也会给公司造成很大的金钱损失。所以，必须要针对Redis集群做降级方案。</p>
<p>比较常见的方案是：<strong>把秒杀抢购流水日志顺序写入秒杀抢购服务所在机器的本地磁盘（可以先写内存再异步刷盘）</strong>，然后返回前端提示“正在抢购中，请耐心等待”。</p>
<p>接着，待Redis集群恢复后，由一个<strong>秒杀降级处理服务，顺序读取磁盘中的秒杀流水日志进行日志重放</strong>，执行Redis库存扣减，后续的流程就完全一样了。</p>
<h3 id="2-2-">2.2 主节点崩溃</h3>
<p>在做Redis的高可用时，有一种非常极端的情况：<strong>Redis主节点崩溃后发生主从切换，切换后数据丢失导致导致库存超卖</strong>。</p>
<p>举个例子来理解下，假设原来Master节点上的可销售库存为100：</p>
<ol>
<li>Redis Master节点扣减完1个库存后宕机了，数据还没同步到Slave；</li>
<li>此时Slave切换为Master，Slave上的可销售库存还是100；</li>
<li>此时最初的那个秒杀抢购请求实际已经成功了，但是可销售库存却没变，导致库存超卖。</li>
</ol>
<p>我这里先强调下，这个问题出现的概率非常非常小，首先Redis Master宕机本身就是小概率问题，宕机后主从切换数据丢失更是小概率事件。事实上，很多公司的线上系统都不会去处理这类问题，退一步说，即使超卖了又怎么样？秒杀下单服务所调用的<strong>订单系统</strong>本身肯定具有防超卖机制的，不可能说这么一个电商平台的核心系统在可销售库存不足时还让你下单成功。</p>
<p>但是，我这里还是要讲解下一种解决方案：</p>
<ol>
<li>首先，直接不用Redis自己的主从架构或Cluster架构，而是<strong>采用Twemproxy这类Redis中间件，自己对Redis做分片，且只做Master节点的分片，取消Slave节和数据异步复制</strong>；</li>
<li>同时，为了防止分片的Redis Master节点宕机引起的服务不可用，做<strong>写磁盘降级处理</strong>，将秒杀抢购流水日志顺序写入秒杀抢购服务所在机器的本地磁盘，待该Redis Master分片恢复后，由一个秒杀降级处理服务，顺序读取磁盘中的秒杀流水日志进行日志重放，执行Redis库存扣减，后续的流程就完全一样了。</li>
</ol>
<h2 id="-">三、订单系统高可用</h2>
<p>订单系统属于电商平台的核心系统，其本身的高可用就是集群部署、横向伸缩。但是，我们要考虑秒杀下单服务调用订单系统下单接口失败的情况。</p>
<p>正常情况下，秒杀下单服务消费MQ中的“秒杀成功通知”消息，然后调用订单系统的下单接口，调用成功后返回MQ确认消费成功的响应。</p>
<p>所以，如果秒杀下单服务调用接口异常，就需要基于MQ的重试队列进行重试，重试几次都不行后，将消息扔进<strong>死信队列</strong>。死信队列中的消息会有专门线程处理，间隔一段时间后（比如1小时）再进行反复重试。</p>
<h2 id="-">四、秒杀抢购服务高可用</h2>
<p>秒杀抢购服务本身是集群部署，因此在高可用方面没什么问题。但是，需要考虑一种特殊情况：<strong>秒杀抢购服务在扣减库存与下单时的异构存储事务执行问题</strong>。</p>
<p>我来具体描述下这类场景：</p>
<ol>
<li>秒杀抢购服务扣减库存成功后，然后还没来得及发送下单通知就宕机了；</li>
<li>对于客户来说，就是在页面上看到“秒杀抢购异常”，但实际上扣减库存已经成功，也就是说用户已经抢购成功了。</li>
</ol>
<p>所以，必须对Redis和MQ做<strong>异构存储的分布式事务方案</strong>，也就是说将<strong>扣减库存</strong>和<strong>下单通知</strong>这两个操作放在同一个分布式事务中。分布式事务的实现方案有很多，可以用TCC框架，也可以用事务消息。</p>
<p>对于这种异构存储的情况，我们可以结合Redis事务和MQ事务，后续实战章节我会详细讲解如何实现。</p>
<h2 id="-">五、多活方案</h2>
<p>为了保证整个秒杀系统的高可用，对于一些大公司来说，必须要做多机房多活、同城双活、异地多活……这种多活方案一定是对整个公司的所有系统都去实施的， 需要数据中心、运维与开发的共同配合，不同公司的方案细节也不相同，我就不赘述了，</p>
<h2 id="-">六、总结</h2>
<p>本章，我对分布式秒杀系统的全链路高可用问题进行了讲解，我们需要重点关注秒杀抢购服务以及中间件的高可用。我在后面实战环节会落地本章给出的核心链路的各种高可用方案。</p>
</div>


<div class="article-footer overflow-initial">所属分类：<a data-original-title="点击查看分布式秒杀分类的文章" data-placement="bottom" data-toggle="tooltip" href="https://www.tpvlog.com/type/66">分布式秒杀</a></div>
</div></body>
        </html>
        